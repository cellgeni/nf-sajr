params{
 outdir = 'scsajr_out'
 SAMPLEFILE = ""
 BARCODEFILE = ""
 bam_on_irods = false
 ref = '/nfs/cellgeni/pasham/code/nf-scsajr/data/refdata-gex-GRCh38-2020-A.sajr'
}

singularity {
  enabled     = true
  autoMounts  = true
  runOptions  = '-B /lustre,/nfs --home /tmp/snare_tmp'
}

executor {
  name = 'lsf'
  perJobMemLimit = true
}

process {
  container   = '/nfs/cellgeni/pasham/singimage/scsajr_r441_v0.1.sif'
  errorStrategy = 'retry'
  
  maxRetries = { task.exitStatus in 130..140 ? 3 : 1 }
  
  withName: get_data {
    cpus = 1
    memory = 2.GB
    queue = 'transfer'
    container = ''
  }

  withName: run_sajr {
    cpus = 1
    queue = 'normal'
  }
  
  withName: combine_sajr_output {
    cpus = 1
    queue = 'normal'
  }
  
  withName: generate_summary {
    cpus = 1
    memory = {5.GB + 5.GB * task.attempt}
    queue = 'normal'
  }
  
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Capturing Nextflow log files into a reports directory
timeline {
   enabled = true
   file = "${params.outdir}/nextflow-reports/timeline.html"
   overwrite = true
}

report {
   enabled = true
   file = "${params.outdir}/nextflow-reports/report.html"
   overwrite = true
}

trace {
   enabled = true
   file = "${params.outdir}/nextflow-reports/trace.txt"
   overwrite = true
}

// Ensures work directories and removed when pipeline completes
cleanup = false
